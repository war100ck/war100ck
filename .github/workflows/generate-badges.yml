name: Generate Repository Badges
on:
  schedule:
    - cron: '0 0 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    paths:
      - 'repos.json'
      - 'scripts/**'

jobs:
  generate-badges:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Generate badges
        run: |
          node scripts/generate-badges.js
      
      - name: Validate SVG files
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ SVG –≤–∞–ª–∏–¥–Ω—ã
          for file in badges/*.svg; do
            echo "Validating $file"
            if ! xmllint --noout "$file" 2>/dev/null; then
              echo "‚ùå Invalid XML in $file"
              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –∞–º–ø–µ—Ä—Å–∞–Ω–¥—ã
              sed -i 's/&\([^a][^m][^p]\)/\&amp;\1/g' "$file"
              sed -i 's/Blade & Soul/Blade \&amp; Soul/g' "$file"
            else
              echo "‚úÖ $file is valid"
            fi
          done
      
      - name: Commit and push badges
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add badges/*.svg
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üîß Fix XML entities in badges [$(date +'%Y-%m-%d %H:%M')]"
            git push
          fi